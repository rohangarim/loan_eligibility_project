import pandas as pd
import sqlite3
import os

# Get the absolute path to the project root
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)
data_file = os.path.join(project_root, "data", "loan_test.xls")

print(f"Looking for file: {data_file}")
print(f"File exists: {os.path.exists(data_file)}")

# Step 1: Read data file (try CSV first, then Excel)
print("\nüìä Reading data file...")
try:
    # Try reading as CSV first (even if extension is .xls)
    df = pd.read_csv(data_file)
    print("‚úÖ Read as CSV")
except:
    try:
        # Try Excel with xlrd engine
        df = pd.read_excel(data_file, engine='xlrd')
        print("‚úÖ Read as Excel (xlrd)")
    except:
        # Try Excel with openpyxl engine
        df = pd.read_excel(data_file, engine='openpyxl')
        print("‚úÖ Read as Excel (openpyxl)")

print(f"‚úÖ Data loaded! Shape: {df.shape}")
print(f"Columns: {list(df.columns)}")

# Step 2: Connect to SQLite database
db_path = os.path.join(project_root, "database", "loan_data.db")
os.makedirs(os.path.dirname(db_path), exist_ok=True)

print(f"\nüíæ Connecting to database...")
conn = sqlite3.connect(db_path)

# Step 3: Import raw data (no cleaning in Python)
print("üìù Importing raw data to 'loan_raw' table...")
df.to_sql("loan_raw", conn, if_exists="replace", index=False)

cursor = conn.cursor()
cursor.execute("SELECT COUNT(*) FROM loan_raw")
count = cursor.fetchone()[0]
print(f"‚úÖ {count} rows imported")

conn.close()
print("\n‚ú® Raw data imported! Now run clean_data.sql to clean the data.")